<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vigneux 2030 - Pilotage Augment√© - Hedi Mechichi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .neon-border { border: 1px solid rgba(59, 130, 246, 0.5); box-shadow: 0 0 20px rgba(59, 130, 246, 0.1); }
        .slider-custom::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 28px; height: 28px;
            background: #3b82f6; cursor: pointer;
            border-radius: 50%; border: 5px solid #1e293b;
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.6);
        }
        .gradient-text { background: linear-gradient(90deg, #60a5fa, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .memo-text p { margin-bottom: 1.2rem; }
        .memo-text strong { color: #60a5fa; font-weight: 800; }
        .verdict-red { color: #f43f5e !important; font-weight: 800; border-left: 4px solid #f43f5e; padding-left: 15px; background: rgba(244, 63, 94, 0.05); padding-top: 10px; padding-bottom: 10px; }
        .verdict-green { color: #10b981 !important; font-weight: 800; border-left: 4px solid #10b981; padding-left: 15px; background: rgba(16, 185, 129, 0.05); padding-top: 10px; padding-bottom: 10px; }
        .status-glow-green { box-shadow: 0 0 20px #10b981; }
        .status-glow-red { box-shadow: 0 0 20px #f43f5e; }
        .status-glow-orange { box-shadow: 0 0 20px #f59e0b; }
        
        .kpi-card { height: 110px; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; }
        .settings-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .settings-open { max-height: 800px; }
    </style>
</head>
<body class="pb-20">

    <div class="max-w-xl mx-auto px-5 pt-10">
        <!-- Header -->
        <header class="mb-12 text-center animate-in fade-in zoom-in duration-700">
            <h1 class="text-5xl font-extrabold tracking-tighter mb-2 uppercase text-white">Vigneux <span class="gradient-text">2030</span></h1>
            <div class="space-y-1">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.4em]">Intelligence D√©cisionnelle Financi√®re</p>
                <div class="h-[1px] w-20 bg-blue-500 mx-auto my-3"></div>
                <p class="text-white text-sm font-black uppercase tracking-[0.6em]">MR. HEDI MECHICHI</p>
            </div>
        </header>

        <!-- KPI Cards -->
        <div class="grid grid-cols-3 gap-3 mb-8 text-center">
            <div class="glass rounded-3xl border-b-4 border-blue-500 shadow-xl kpi-card">
                <p class="text-[8px] font-bold text-slate-500 uppercase mb-1 tracking-widest px-1">CAF Nette</p>
                <p id="metricCAF" class="text-lg font-black text-blue-400 truncate w-full">1.90 M‚Ç¨</p>
            </div>
            <div class="glass rounded-3xl border-b-4 border-slate-700 shadow-xl kpi-card">
                <p class="text-[8px] font-bold text-slate-500 uppercase mb-1 tracking-widest px-1 leading-tight text-center">D√©sendettement</p>
                <p id="metricDette" class="text-lg font-black text-white truncate w-full">7.2 ans</p>
            </div>
            <div class="glass rounded-3xl shadow-xl kpi-card">
                <p class="text-[8px] font-bold text-slate-500 uppercase mb-2 tracking-widest px-1">Alerte</p>
                <div id="statusIndicator" class="w-4 h-4 rounded-full transition-all duration-500 status-glow-green bg-emerald-500"></div>
            </div>
        </div>

        <!-- Configuration Budget -->
        <div class="mb-6 px-2">
            <button onclick="document.getElementById('baseData').classList.toggle('settings-open')" class="w-full flex items-center justify-between text-[10px] font-black uppercase text-blue-400 tracking-[0.2em] py-3 px-4 glass rounded-2xl border-blue-500/30">
                <span class="flex items-center gap-2">‚öôÔ∏è Param√®tres de Structure</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="baseData" class="settings-content space-y-4 pt-4 px-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-slate-500 uppercase">Recettes de base (M‚Ç¨)</label>
                        <input type="number" id="baseRInput" value="45.0" step="0.1" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-sm font-bold text-white outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-slate-500 uppercase">D√©penses de base (M‚Ç¨)</label>
                        <input type="number" id="baseDInput" value="41.6" step="0.1" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-sm font-bold text-white outline-none">
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-slate-500 uppercase">Encours de Dette (M‚Ç¨)</label>
                    <input type="number" id="stockDetteInput" value="24.5" step="0.1" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-sm font-bold text-white outline-none">
                </div>
            </div>
        </div>

        <!-- Simulation -->
        <div class="glass p-8 rounded-[3rem] mb-4 space-y-10 border border-white/5 shadow-2xl relative overflow-hidden">
            <!-- OPTIMIZER BUTTON -->
            <button id="optimizeBtn" class="absolute top-4 right-6 text-[9px] font-black bg-emerald-600/20 text-emerald-400 border border-emerald-500/50 px-3 py-1.5 rounded-full hover:bg-emerald-600 hover:text-white transition-all uppercase tracking-widest">
                Cible : 10 ans de dette
            </button>

            <div class="space-y-5">
                <div class="flex justify-between items-center text-xs font-bold text-slate-400 uppercase">
                    <label class="tracking-wider">Levier Fiscal (TF)</label>
                    <span id="taxVal" class="text-blue-400 font-black text-2xl tracking-tighter">+0%</span>
                </div>
                <input type="range" id="taxSlider" min="-5" max="15" value="0" step="0.5" class="w-full h-2 bg-slate-800 rounded-full appearance-none slider-custom">
            </div>

            <div class="space-y-5">
                <div class="flex justify-between items-center text-xs font-bold text-slate-400 uppercase">
                    <label class="tracking-wider">Nouveaux Investissements (M‚Ç¨)</label>
                    <span id="investVal" class="text-white font-black text-2xl tracking-tighter">0 M‚Ç¨</span>
                </div>
                <input type="range" id="investSlider" min="0" max="50" value="0" step="1" class="w-full h-2 bg-slate-800 rounded-full appearance-none slider-custom">
            </div>

            <div class="space-y-5">
                <div class="flex justify-between items-center text-xs font-bold text-slate-400 uppercase">
                    <label class="tracking-wider">Taux de Subvention (%)</label>
                    <span id="subVal" class="text-emerald-400 font-black text-2xl tracking-tighter">30%</span>
                </div>
                <input type="range" id="subSlider" min="0" max="85" value="30" step="5" class="w-full h-2 bg-slate-800 rounded-full appearance-none slider-custom">
            </div>
        </div>

        <!-- Optimizer Message -->
        <div id="optimizerMsg" class="hidden px-6 py-3 bg-blue-600/10 border border-blue-500/30 rounded-2xl mb-8">
            <p class="text-[10px] text-blue-300 font-bold italic"></p>
        </div>

        <!-- Prudence -->
        <div class="mb-10 px-2">
            <button onclick="document.getElementById('advSettings').classList.toggle('settings-open')" class="w-full flex items-center justify-between text-[10px] font-black uppercase text-slate-500 tracking-[0.2em] py-2 border-b border-slate-800">
                <span>Contraintes de Conjoncture</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="advSettings" class="settings-content space-y-6 pt-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[9px] font-bold text-slate-500 uppercase">Inflation (%)</label>
                        <input type="number" id="inflationInput" value="2.5" step="0.1" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-sm font-bold text-white outline-none">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-bold text-slate-500 uppercase">GVT (Masse Sal.) (%)</label>
                        <input type="number" id="gvtInput" value="1.8" step="0.1" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-sm font-bold text-white outline-none">
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="glass p-8 rounded-[3rem] mb-10 border border-white/5 shadow-inner">
            <div class="h-44">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- Action Button -->
        <button id="wowBtn" class="w-full bg-blue-600 hover:bg-blue-500 active:scale-95 text-white font-black py-6 rounded-[2.5rem] shadow-2xl transition-all flex items-center justify-center gap-4 uppercase text-sm tracking-[0.2em]">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
            Audit Strat√©gique
        </button>

        <!-- AI Output Area -->
        <div id="aiSection" class="hidden mt-12 space-y-8 animate-in slide-in-from-bottom duration-1000">
            <div id="aiContainer" class="glass p-10 rounded-[3.5rem] border-2 border-slate-700 shadow-3xl">
                <div class="flex items-center gap-5 mb-10">
                    <div class="w-14 h-14 bg-blue-500/10 rounded-3xl flex items-center justify-center text-blue-400">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10l4 4v10a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <div>
                        <h3 class="font-extrabold text-white text-xl tracking-tight uppercase">Note Strat√©gique M57</h3>
                        <p class="text-[9px] text-blue-400 font-black uppercase tracking-widest">Expertise Hedi Mechichi</p>
                    </div>
                </div>
                <div id="aiLoading" class="hidden py-12 text-center">
                    <div class="inline-block w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
                <div id="aiContent" class="memo-text text-slate-200 leading-relaxed text-base font-medium"></div>
            </div>
            <div id="imageBox" class="relative group hidden overflow-hidden rounded-[3.5rem]">
                <img id="visionImage" class="w-full h-80 object-cover border border-white/10 shadow-2xl" src="" alt="Vigneux Vision">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-transparent opacity-80"></div>
                <div class="absolute bottom-8 left-10 right-10">
                    <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-2">Projection Architectural</p>
                    <p class="text-sm text-white font-semibold italic">"Transition √©cologique et modernisation du territoire."</p>
                </div>
            </div>
        </div>

        <footer class="mt-20 text-center pb-10">
            <p class="text-slate-700 text-[10px] font-black uppercase tracking-[0.5em]">Vision Confidentielle ‚Ä¢ Simulation Par Hedi Mechichi</p>
        </footer>
    </div>

    <script>
        const apiKey = "";
        let metrics = {};

        const ctx = document.getElementById('mainChart').getContext('2d');
        const mainChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['2025', '2026', '2027', '2028', '2029', '2030'],
                datasets: [{
                    data: [0, 0, 0, 0, 0, 0],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.05)',
                    borderWidth: 4,
                    pointRadius: 4,
                    pointBackgroundColor: '#3b82f6',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { display: false, min: 0 },
                    x: { grid: { display: false }, ticks: { color: '#475569', font: { weight: 'bold', size: 10 } } }
                }
            }
        });

        function calculateRatio(tax, invest, sub, baseR, baseD, stockDette, inflation, gvt) {
            const r = baseR * (1 + (tax / 100));
            const adjD = baseD + (baseD * 0.35 * (inflation/100)) + (baseD * 0.65 * (gvt/100));
            const e = r - adjD;
            const reste = Math.max(0, invest - (invest * (sub / 100)));
            return e > 0.1 ? ((stockDette + reste) / e) : 50;
        }

        function update() {
            const BASE_R = parseFloat(document.getElementById('baseRInput').value) || 45.0;
            const BASE_D = parseFloat(document.getElementById('baseDInput').value) || 41.6;
            const STOCK_DETTE = parseFloat(document.getElementById('stockDetteInput').value) || 24.5;
            const tax = parseFloat(document.getElementById('taxSlider').value);
            const invest = parseFloat(document.getElementById('investSlider').value);
            const sub = parseFloat(document.getElementById('subSlider').value);
            const infl = parseFloat(document.getElementById('inflationInput').value);
            const gvt = parseFloat(document.getElementById('gvtInput').value);

            document.getElementById('taxVal').innerText = (tax >= 0 ? '+' : '') + tax + '%';
            document.getElementById('investVal').innerText = invest + " M‚Ç¨";
            document.getElementById('subVal').innerText = sub + "%";

            const r = BASE_R * (1 + (tax / 100));
            const e = r - (BASE_D + (BASE_D * 0.35 * (infl/100)) + (BASE_D * 0.65 * (gvt/100)));
            const reste = Math.max(0, invest - (invest * (sub / 100)));
            const caf = Math.max(0, e - 1.5 - (reste * 0.038)); 
            const ratio = calculateRatio(tax, invest, sub, BASE_R, BASE_D, STOCK_DETTE, infl, gvt);

            document.getElementById('metricCAF').innerText = caf.toFixed(2) + " M‚Ç¨";
            document.getElementById('metricDette').innerText = ratio.toFixed(1) + " ans";
            
            const indicator = document.getElementById('statusIndicator');
            if (ratio < 8.5) { indicator.className = "w-4 h-4 rounded-full transition-all status-glow-green bg-emerald-500"; }
            else if (ratio < 11.5) { indicator.className = "w-4 h-4 rounded-full transition-all status-glow-orange bg-orange-500"; }
            else { indicator.className = "w-4 h-4 rounded-full transition-all status-glow-red bg-rose-500"; }

            mainChart.data.datasets[0].data = [BASE_R - BASE_D, e, e*1.02, e*1.03, e*1.04, e*1.05];
            mainChart.update();

            metrics = { r, e, caf, ratio, invest, sub, tax, reste, infl, gvt };
        }

        // OPTIMIZER: TARGET 10 YEARS (REALISTIC)
        document.getElementById('optimizeBtn').addEventListener('click', () => {
            const BASE_R = parseFloat(document.getElementById('baseRInput').value);
            const BASE_D = parseFloat(document.getElementById('baseDInput').value);
            const STOCK_DETTE = parseFloat(document.getElementById('stockDetteInput').value);
            const invest = parseFloat(document.getElementById('investSlider').value);
            const infl = parseFloat(document.getElementById('inflationInput').value);
            const gvt = parseFloat(document.getElementById('gvtInput').value);

            let bestS = 30; // Start at default sub
            let bestT = 0;
            let found = false;
            const TARGET = 10.0;

            // Step 1: Push Subventions to a realistic 50%
            for (let s = 30; s <= 50; s += 2) {
                if (calculateRatio(0, invest, s, BASE_R, BASE_D, STOCK_DETTE, infl, gvt) <= TARGET) {
                    bestS = s; bestT = 0; found = true; break;
                }
            }

            // Step 2: If not enough, push Tax and Sub combined
            if (!found) {
                for (let t = 0.5; t <= 10; t += 0.5) {
                    for (let s = 40; s <= 60; s += 5) {
                        if (calculateRatio(t, invest, s, BASE_R, BASE_D, STOCK_DETTE, infl, gvt) <= TARGET) {
                            bestS = s; bestT = t; found = true; break;
                        }
                    }
                    if (found) break;
                }
            }

            document.getElementById('subSlider').value = bestS;
            document.getElementById('taxSlider').value = bestT;
            
            const msg = document.getElementById('optimizerMsg');
            msg.classList.remove('hidden');
            msg.querySelector('p').innerText = found ? 
                `üéØ Cible atteinte : √âquilibre √† ${TARGET} ans avec +${bestT}% de taxe et ${bestS}% de subventions.` :
                `‚ö†Ô∏è Impossible d'atteindre la cible : Le projet exc√®de la capacit√© de d√©sendettement de 10 ans.`;
            
            update();
        });

        ['baseRInput', 'baseDInput', 'stockDetteInput', 'taxSlider', 'investSlider', 'subSlider', 'inflationInput', 'gvtInput'].forEach(id => {
            document.getElementById(id).addEventListener('input', update);
        });

        function generateLocalStrategicNote(m) {
            let note = `<p><strong>Diagnostic CFO :</strong> La trajectoire d√©gage une √©pargne brute de <strong>${m.e.toFixed(2)} M‚Ç¨</strong>.</p>`;
            if (m.ratio > 12) note += `<p class="verdict-red">‚ö†Ô∏è REJET : Le ratio de <strong>${m.ratio.toFixed(1)} ans</strong> est hors cadre de s√©curit√© territoriale.</p>`;
            else note += `<p class="verdict-green">‚úÖ VALID√â : Le ratio de <strong>${m.ratio.toFixed(1)} ans</strong> pr√©serve notre signature financi√®re "A".</p>`;
            return note;
        }

        document.getElementById('wowBtn').addEventListener('click', async () => {
            const section = document.getElementById('aiSection');
            const content = document.getElementById('aiContent');
            const loading = document.getElementById('aiLoading');
            const imgBox = document.getElementById('imageBox');
            const img = document.getElementById('visionImage');

            section.classList.remove('hidden');
            section.scrollIntoView({ behavior: 'smooth' });
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            imgBox.classList.add('hidden');

            const sysPrompt = `Tu es Hedi Mechichi, CFO expert de Vigneux. Ton verdict est impitoyable sur les ratios M57. Pas de signature.`;
            const userPrompt = `Simulation : Taxe +${metrics.tax}%, Subventions ${metrics.sub}%, Ratio Dette ${metrics.ratio.toFixed(1)}ans. Verdict sur l'objectif de 10 ans ?`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: sysPrompt }] } })
                }).then(r => r.json());

                content.innerHTML = res.candidates[0].content.parts[0].text.split('\n').filter(p => p.trim()).map(p => {
                    let cls = "";
                    if (p.includes("REJET") || p.includes("NON SOUTENABLE")) cls = "verdict-red";
                    if (p.includes("VALID") || p.includes("SOUTENABLE")) cls = "verdict-green";
                    return `<p class="${cls}">${p.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>`;
                }).join('');

                const imgRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instances: { prompt: "Eco-friendly sustainable urban development project, modern public building, 8k architectural photorealistic concept." }, parameters: { sampleCount: 1 } })
                }).then(r => r.json());

                if (imgRes.predictions?.[0]?.bytesBase64Encoded) {
                    img.src = `data:image/png;base64,${imgRes.predictions[0].bytesBase64Encoded}`;
                    imgBox.classList.remove('hidden');
                }
            } catch (e) {
                content.innerHTML = generateLocalStrategicNote(metrics);
            } finally {
                loading.classList.add('hidden');
                content.classList.remove('hidden');
            }
        });

        window.onload = update;
    </script>
</body>
</html>

