<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vigneux 2030 - Pilotage Augmenté - Hedi Mechichi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .neon-border { border: 1px solid rgba(59, 130, 246, 0.5); box-shadow: 0 0 20px rgba(59, 130, 246, 0.1); }
        .slider-custom::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 28px; height: 28px;
            background: #3b82f6; cursor: pointer;
            border-radius: 50%; border: 5px solid #1e293b;
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.6);
        }
        .gradient-text { background: linear-gradient(90deg, #60a5fa, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .memo-text p { margin-bottom: 1.2rem; }
        .memo-text strong { color: #60a5fa; font-weight: 800; }
        .verdict-red { color: #f43f5e !important; font-weight: 800; border-left: 4px solid #f43f5e; padding-left: 15px; background: rgba(244, 63, 94, 0.05); padding-top: 10px; padding-bottom: 10px; }
        .verdict-green { color: #10b981 !important; font-weight: 800; border-left: 4px solid #10b981; padding-left: 15px; background: rgba(16, 185, 129, 0.05); padding-top: 10px; padding-bottom: 10px; }
        .status-glow-green { box-shadow: 0 0 20px #10b981; }
        .status-glow-red { box-shadow: 0 0 20px #f43f5e; }
        .status-glow-orange { box-shadow: 0 0 20px #f59e0b; }
        
        .kpi-card { height: 110px; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; }
        
        .settings-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .settings-open { max-height: 800px; }
    </style>
</head>
<body class="pb-20">

    <div class="max-w-xl mx-auto px-5 pt-10">
        <!-- Header -->
        <header class="mb-12 text-center animate-in fade-in zoom-in duration-700">
            <h1 class="text-5xl font-extrabold tracking-tighter mb-2 uppercase">Vigneux <span class="gradient-text">2030</span></h1>
            <div class="space-y-1">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.4em]">Plateforme de Pilotage Stratégique</p>
                <div class="h-[1px] w-20 bg-blue-500 mx-auto my-3"></div>
                <p class="text-white text-sm font-black uppercase tracking-[0.6em]">MR. HEDI MECHICHI</p>
            </div>
        </header>

        <!-- KPI Cards -->
        <div class="grid grid-cols-3 gap-3 mb-10 text-center">
            <div class="glass rounded-3xl border-b-4 border-blue-500 shadow-xl kpi-card">
                <p class="text-[8px] font-bold text-slate-500 uppercase mb-1 tracking-widest px-1">CAF Nette</p>
                <p id="metricCAF" class="text-lg font-black text-blue-400 truncate w-full">1.90 M€</p>
            </div>
            <div class="glass rounded-3xl border-b-4 border-slate-700 shadow-xl kpi-card">
                <p class="text-[8px] font-bold text-slate-500 uppercase mb-1 tracking-widest px-1 leading-tight">Désendettement</p>
                <p id="metricDette" class="text-lg font-black text-white truncate w-full">7.2 ans</p>
            </div>
            <div class="glass rounded-3xl shadow-xl kpi-card">
                <p class="text-[8px] font-bold text-slate-500 uppercase mb-2 tracking-widest px-1">Alerte</p>
                <div id="statusIndicator" class="w-4 h-4 rounded-full transition-all duration-500 status-glow-green bg-emerald-500"></div>
            </div>
        </div>

        <!-- Configuration des Données (NOUVEAU - POUR LA MISE À JOUR ANNUELLE) -->
        <div class="mb-6 px-2">
            <button onclick="document.getElementById('baseData').classList.toggle('settings-open')" class="w-full flex items-center justify-between text-[10px] font-black uppercase text-blue-400 tracking-[0.2em] py-3 px-4 glass rounded-2xl border-blue-500/30">
                <span class="flex items-center gap-2"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg> Configuration Données de Base</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="baseData" class="settings-content space-y-4 pt-4 px-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-slate-500 uppercase">Recettes réelles (M€)</label>
                        <input type="number" id="baseRInput" value="45.0" step="0.1" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-sm font-bold text-white outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-slate-500 uppercase">Dépenses réelles (M€)</label>
                        <input type="number" id="baseDInput" value="41.6" step="0.1" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-sm font-bold text-white outline-none">
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-slate-500 uppercase">Encours de Dette (M€)</label>
                    <input type="number" id="stockDetteInput" value="24.5" step="0.1" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-sm font-bold text-white outline-none">
                </div>
                <p class="text-[9px] text-slate-600 italic">Modifiez ces valeurs lors du vote du Compte Administratif pour mettre à jour la base de simulation.</p>
            </div>
        </div>

        <!-- Simulation Controls -->
        <div class="glass p-8 rounded-[3rem] mb-6 space-y-10 border border-white/5 shadow-2xl">
            <div class="space-y-5">
                <div class="flex justify-between items-center">
                    <label class="text-[11px] font-black uppercase text-slate-400 tracking-wider">Levier Fiscal</label>
                    <span id="taxVal" class="text-blue-400 font-black text-2xl tracking-tighter">+0%</span>
                </div>
                <input type="range" id="taxSlider" min="-5" max="15" value="0" step="0.5" class="w-full h-2 bg-slate-800 rounded-full appearance-none slider-custom">
            </div>

            <div class="space-y-5">
                <div class="flex justify-between items-center text-[11px] font-black uppercase text-slate-400 tracking-wider">
                    <label>Projets de Mandat (M€)</label>
                    <span id="investVal" class="text-white font-black text-2xl tracking-tighter">0 M€</span>
                </div>
                <input type="range" id="investSlider" min="0" max="50" value="0" step="1" class="w-full h-2 bg-slate-800 rounded-full appearance-none slider-custom">
            </div>

            <div class="space-y-5">
                <div class="flex justify-between items-center text-[11px] font-black uppercase text-slate-400 tracking-wider">
                    <label>Co-financements (Aides)</label>
                    <span id="subVal" class="text-emerald-400 font-black text-2xl tracking-tighter">30%</span>
                </div>
                <input type="range" id="subSlider" min="0" max="85" value="30" step="5" class="w-full h-2 bg-slate-800 rounded-full appearance-none slider-custom">
            </div>
        </div>

        <!-- Advanced Informational Inputs -->
        <div class="mb-10 px-2">
            <button onclick="document.getElementById('advSettings').classList.toggle('settings-open')" class="w-full flex items-center justify-between text-[10px] font-black uppercase text-slate-500 tracking-[0.2em] py-2 border-b border-slate-800">
                <span>Variables de Prudence (Inflation/GVT)</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="advSettings" class="settings-content space-y-6 pt-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-[9px] font-bold text-slate-500 uppercase">Inflation / Énergie (%)</label>
                        <input type="number" id="inflationInput" value="2.5" step="0.1" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-sm font-bold text-white outline-none">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-bold text-slate-500 uppercase">Masse Salariale / GVT (%)</label>
                        <input type="number" id="gvtInput" value="1.8" step="0.1" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-sm font-bold text-white outline-none">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[9px] font-bold text-slate-500 uppercase">Taux d'emprunt prévisionnel (%)</label>
                    <input type="number" id="rateInput" value="3.8" step="0.1" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-sm font-bold text-white outline-none">
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="glass p-8 rounded-[3rem] mb-10 border border-white/5 shadow-inner">
            <div class="h-44">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- Audit Button -->
        <button id="wowBtn" class="w-full bg-blue-600 hover:bg-blue-500 active:scale-95 text-white font-black py-6 rounded-[2.5rem] shadow-2xl shadow-blue-500/30 transition-all flex items-center justify-center gap-4 uppercase text-sm tracking-[0.2em]">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
            Éditer l'Audit Stratégique
        </button>

        <!-- Output Area -->
        <div id="aiSection" class="hidden mt-12 space-y-8 animate-in slide-in-from-bottom duration-1000">
            <div id="aiContainer" class="glass p-10 rounded-[3.5rem] border-2 border-slate-700 shadow-3xl">
                <div class="flex items-center gap-5 mb-10">
                    <div class="w-14 h-14 bg-blue-500/10 rounded-3xl flex items-center justify-center text-blue-400">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10l4 4v10a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <div>
                        <h3 class="font-extrabold text-white text-xl tracking-tight uppercase">Note Stratégique M57</h3>
                        <p class="text-[9px] text-blue-400 font-black uppercase tracking-widest">Expertise Hedi Mechichi</p>
                    </div>
                </div>
                <div id="aiLoading" class="hidden py-12 text-center">
                    <div class="inline-block w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
                <div id="aiContent" class="memo-text text-slate-200 leading-relaxed text-base font-medium"></div>
            </div>
            <div id="imageBox" class="relative group hidden overflow-hidden rounded-[3.5rem]">
                <img id="visionImage" class="w-full h-80 object-cover border border-white/10 shadow-2xl transition-transform duration-1000 group-hover:scale-110" src="" alt="Vigneux Vision">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-transparent to-transparent opacity-80"></div>
                <div class="absolute bottom-8 left-10 right-10">
                    <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-2">Projection Architectural</p>
                    <p class="text-sm text-white font-semibold italic">"Transition écologique et modernisation du territoire."</p>
                </div>
            </div>
        </div>

        <footer class="mt-20 text-center pb-10">
            <p class="text-slate-700 text-[10px] font-black uppercase tracking-[0.5em]">Vision Confidentielle • Simulation Par Hedi Mechichi</p>
        </footer>
    </div>

    <script>
        const apiKey = "";
        let metrics = {};

        const ctx = document.getElementById('mainChart').getContext('2d');
        const mainChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['2025', '2026', '2027', '2028', '2029', '2030'],
                datasets: [{
                    data: [0, 0, 0, 0, 0, 0],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.05)',
                    borderWidth: 4,
                    pointRadius: 4,
                    pointBackgroundColor: '#3b82f6',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { display: false, min: 0 },
                    x: { grid: { display: false }, ticks: { color: '#475569', font: { weight: 'bold', size: 10 } } }
                }
            }
        });

        function update() {
            // Base Inputs (DYNAMIC)
            const BASE_R = parseFloat(document.getElementById('baseRInput').value) || 45.0;
            const BASE_D = parseFloat(document.getElementById('baseDInput').value) || 41.6;
            const STOCK_DETTE = parseFloat(document.getElementById('stockDetteInput').value) || 24.5;

            const tax = parseFloat(document.getElementById('taxSlider').value);
            const investTotal = parseFloat(document.getElementById('investSlider').value);
            const subRate = parseFloat(document.getElementById('subSlider').value);
            
            const inflation = parseFloat(document.getElementById('inflationInput').value) / 100 || 0;
            const gvt = parseFloat(document.getElementById('gvtInput').value) / 100 || 0;
            const newRate = parseFloat(document.getElementById('rateInput').value) / 100 || 0.038;

            document.getElementById('taxVal').innerText = (tax >= 0 ? '+' : '') + tax + '%';
            document.getElementById('investVal').innerText = investTotal + " M€";
            document.getElementById('subVal').innerText = subRate + "%";

            // Calculation
            const r = BASE_R * (1 + (tax / 100));
            const inflationImpact = (BASE_D * 0.35 * inflation);
            const gvtImpact = (BASE_D * 0.65 * gvt);
            const adjusted_D = BASE_D + inflationImpact + gvtImpact;
            
            const e = r - adjusted_D;
            const subventions = investTotal * (subRate / 100);
            const resteAFinancer = Math.max(0, investTotal - subventions);
            
            const caf = Math.max(0, e - 1.5 - (resteAFinancer * newRate)); 
            const ratio = e > 0.1 ? ((STOCK_DETTE + resteAFinancer) / e) : 50;

            document.getElementById('metricCAF').innerText = caf.toFixed(2) + " M€";
            document.getElementById('metricDette').innerText = ratio.toFixed(1) + " ans";
            
            const indicator = document.getElementById('statusIndicator');
            if (ratio < 8.5) { indicator.className = "w-4 h-4 rounded-full transition-all status-glow-green bg-emerald-500"; }
            else if (ratio < 11.5) { indicator.className = "w-4 h-4 rounded-full transition-all status-glow-orange bg-orange-500"; }
            else { indicator.className = "w-4 h-4 rounded-full transition-all status-glow-red bg-rose-500"; }

            const initialEpargne = BASE_R - BASE_D;
            mainChart.data.datasets[0].data = [initialEpargne, e, e*1.02, e*1.03, e*1.04, e*1.05];
            mainChart.update();

            metrics = { r, e, caf, ratio, investTotal, subRate, tax, resteAFinancer, inflation, gvt, newRate };
        }

        // Listeners for all inputs
        ['baseRInput', 'baseDInput', 'stockDetteInput', 'taxSlider', 'investSlider', 'subSlider', 'inflationInput', 'gvtInput', 'rateInput'].forEach(id => {
            document.getElementById(id).addEventListener('input', update);
        });

        function generateLocalStrategicNote(m) {
            let note = `<p><strong>Diagnostic de la Direction :</strong> Sur la base des données actualisées, le budget dégage une épargne brute de <strong>${m.e.toFixed(2)} M€</strong>.</p>`;
            if (m.ratio > 12) {
                note += `<p class="verdict-red">⚠️ ALERTE : Scénario non soutenable. Le ratio de <strong>${m.ratio.toFixed(1)} ans</strong> bloque toute capacité d'emprunt.</p>`;
            } else if (m.ratio > 10) {
                note += `<p class="text-orange-400 font-bold">⚠️ VIGILANCE : Pilotage sous tension. L'autofinancement net est insuffisant pour ce projet.</p>`;
            } else {
                note += `<p class="verdict-green">✅ VALIDATION : Scénario robuste. Le ratio de <strong>${m.ratio.toFixed(1)} ans</strong> préserve les marges de manœuvre du mandat.</p>`;
            }
            return note;
        }

        document.getElementById('wowBtn').addEventListener('click', async () => {
            const section = document.getElementById('aiSection');
            const content = document.getElementById('aiContent');
            const loading = document.getElementById('aiLoading');
            const imgBox = document.getElementById('imageBox');
            const img = document.getElementById('visionImage');
            const container = document.getElementById('aiContainer');

            section.classList.remove('hidden');
            section.scrollIntoView({ behavior: 'smooth' });
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            imgBox.classList.add('hidden');

            const sysPrompt = `Tu es Hedi Mechichi, Directeur des Finances expert. Analyse ce budget basé sur des données réelles. Verdict court. Pas de signature.`;
            const userPrompt = `Simulation : CAF Nette ${metrics.caf.toFixed(2)}M€, Désendettement ${metrics.ratio.toFixed(1)}ans. Verdict ?`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: sysPrompt }] } })
                }).then(r => r.json());

                const text = res.candidates[0].content.parts[0].text;
                content.innerHTML = text.split('\n').filter(p => p.trim()).map(p => {
                    let cls = "";
                    if (p.includes("REJETÉ") || p.includes("NON SOUTENABLE")) cls = "verdict-red";
                    if (p.includes("VALIDÉ") || p.includes("SOUTENABLE")) cls = "verdict-green";
                    return `<p class="${cls}">${p.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>`;
                }).join('');

                const imgRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instances: { prompt: "Eco-friendly sustainable urban development project in France, futuristic public building, 8k architectural concept." }, parameters: { sampleCount: 1 } })
                }).then(r => r.json());

                if (imgRes.predictions?.[0]?.bytesBase64Encoded) {
                    img.src = `data:image/png;base64,${imgRes.predictions[0].bytesBase64Encoded}`;
                    imgBox.classList.remove('hidden');
                }
            } catch (e) {
                content.innerHTML = generateLocalStrategicNote(metrics);
            } finally {
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                container.className = metrics.ratio > 12 ? "glass p-10 rounded-[3.5rem] border-2 border-rose-600 shadow-3xl" : "glass p-10 rounded-[3.5rem] border-2 border-blue-500 shadow-3xl";
            }
        });

        window.onload = update;
    </script>
</body>
</html>

