<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vigneux 2030 - Pilotage Augmenté - Hedi Mechichi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .neon-border { border: 1px solid rgba(59, 130, 246, 0.5); box-shadow: 0 0 20px rgba(59, 130, 246, 0.1); }
        .slider-custom::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 28px; height: 28px;
            background: #3b82f6; cursor: pointer;
            border-radius: 50%; border: 5px solid #1e293b;
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.6);
        }
        .gradient-text { background: linear-gradient(90deg, #60a5fa, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .memo-text p { margin-bottom: 1.2rem; }
        .memo-text strong { color: #60a5fa; font-weight: 800; }
        .verdict-red { color: #f43f5e !important; font-weight: 800; border-left: 4px solid #f43f5e; padding-left: 15px; background: rgba(244, 63, 94, 0.05); padding-top: 10px; padding-bottom: 10px; }
        .verdict-green { color: #10b981 !important; font-weight: 800; border-left: 4px solid #10b981; padding-left: 15px; background: rgba(16, 185, 129, 0.05); padding-top: 10px; padding-bottom: 10px; }
        .status-glow-green { box-shadow: 0 0 20px #10b981; }
        .status-glow-red { box-shadow: 0 0 20px #f43f5e; }
        .status-glow-orange { box-shadow: 0 0 20px #f59e0b; }
        
        /* Fixed height for KPI cards to prevent shifting */
        .kpi-card { height: 110px; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; }
    </style>
</head>
<body class="pb-20">

    <div class="max-w-xl mx-auto px-5 pt-10">
        <!-- Header Personnalisé -->
        <header class="mb-12 text-center animate-in fade-in zoom-in duration-700">
            <h1 class="text-5xl font-extrabold tracking-tighter mb-2 uppercase">Vigneux <span class="gradient-text">2030</span></h1>
            <div class="space-y-1">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.4em]">Expertise Financière Stratégique</p>
                <div class="h-[1px] w-20 bg-blue-500 mx-auto my-3"></div>
                <p class="text-white text-sm font-black uppercase tracking-[0.6em]">MR. HEDI MECHICHI</p>
            </div>
        </header>

        <!-- Indicateurs Temps Réel (FIXED SIZE) -->
        <div class="grid grid-cols-3 gap-3 mb-10">
            <div class="glass rounded-3xl text-center border-b-4 border-blue-500 shadow-xl kpi-card">
                <p class="text-[8px] font-bold text-slate-500 uppercase mb-1 tracking-widest px-1">CAF Nette</p>
                <p id="metricCAF" class="text-lg font-black text-blue-400 truncate w-full">1.90 M€</p>
            </div>
            <div class="glass rounded-3xl text-center border-b-4 border-slate-700 shadow-xl kpi-card">
                <p class="text-[8px] font-bold text-slate-500 uppercase mb-1 tracking-widest px-1 leading-tight">Désendettement</p>
                <p id="metricDette" class="text-lg font-black text-white truncate w-full">7.2 ans</p>
            </div>
            <div class="glass rounded-3xl text-center shadow-xl kpi-card">
                <p class="text-[8px] font-bold text-slate-500 uppercase mb-2 tracking-widest px-1">Alerte</p>
                <div id="statusIndicator" class="w-4 h-4 rounded-full transition-all duration-500 status-glow-green bg-emerald-500"></div>
            </div>
        </div>

        <!-- Panneau de Contrôle -->
        <div class="glass p-8 rounded-[3rem] mb-10 space-y-12 border border-white/5 shadow-2xl">
            <!-- Taxe -->
            <div class="space-y-5">
                <div class="flex justify-between items-center">
                    <label class="text-[11px] font-black uppercase text-slate-400 tracking-wider">Levier Fiscal (Taxe Foncière)</label>
                    <span id="taxVal" class="text-blue-400 font-black text-2xl tracking-tighter">+0%</span>
                </div>
                <input type="range" id="taxSlider" min="-5" max="15" value="0" step="0.5" class="w-full h-2 bg-slate-800 rounded-full appearance-none slider-custom">
            </div>

            <!-- Investissement -->
            <div class="space-y-5">
                <div class="flex justify-between items-center text-[11px] font-black uppercase text-slate-400 tracking-wider">
                    <label>Projets de Mandat (M€)</label>
                    <span id="investVal" class="text-white font-black text-2xl tracking-tighter">0 M€</span>
                </div>
                <input type="range" id="investSlider" min="0" max="50" value="0" step="1" class="w-full h-2 bg-slate-800 rounded-full appearance-none slider-custom">
            </div>

            <!-- Subventions -->
            <div class="space-y-5">
                <div class="flex justify-between items-center text-[11px] font-black uppercase text-slate-400 tracking-wider">
                    <label>Co-financements (Aides)</label>
                    <span id="subVal" class="text-emerald-400 font-black text-2xl tracking-tighter">30%</span>
                </div>
                <input type="range" id="subSlider" min="0" max="85" value="30" step="5" class="w-full h-2 bg-slate-800 rounded-full appearance-none slider-custom">
            </div>
        </div>

        <!-- Courbe de Tendance -->
        <div class="glass p-8 rounded-[3rem] mb-10 border border-white/5 shadow-inner">
            <h3 class="text-[10px] font-black text-slate-500 uppercase mb-6 tracking-[0.3em] text-center">Évolution de l'Autofinancement (M€)</h3>
            <div class="h-44">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- Bouton Action -->
        <button id="wowBtn" class="w-full bg-blue-600 hover:bg-blue-500 active:scale-95 text-white font-black py-6 rounded-[2.5rem] shadow-2xl shadow-blue-500/30 transition-all flex items-center justify-center gap-4 uppercase text-sm tracking-[0.2em]">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
            Audit Stratégique
        </button>

        <!-- Zone de Sortie IA -->
        <div id="aiSection" class="hidden mt-12 space-y-8 animate-in slide-in-from-bottom duration-1000">
            <!-- Analyse -->
            <div id="aiContainer" class="glass p-10 rounded-[3.5rem] border-2 border-slate-700 shadow-3xl">
                <div class="flex items-center gap-5 mb-10">
                    <div class="w-14 h-14 bg-blue-500/10 rounded-3xl flex items-center justify-center text-blue-400 shadow-inner">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10l4 4v10a2 2 0 01-2 2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 2v4a2 2 0 002 2h4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h3m-3 4h5m-5 4h5"></path></svg>
                    </div>
                    <div>
                        <h3 class="font-extrabold text-white text-xl tracking-tight uppercase">Note Stratégique M57</h3>
                        <p class="text-[9px] text-blue-400 font-black uppercase tracking-widest">Signé : Hedi Mechichi</p>
                    </div>
                </div>

                <div id="aiLoading" class="hidden py-12 text-center">
                    <div class="inline-block w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <p class="mt-6 text-sm text-slate-500 italic font-bold">Consolidation des ratios en cours...</p>
                </div>

                <div id="aiContent" class="memo-text text-slate-200 leading-relaxed text-base font-medium">
                    <!-- Contenu IA -->
                </div>
            </div>

            <!-- Vision Urbaine -->
            <div id="imageBox" class="relative group hidden overflow-hidden rounded-[3.5rem]">
                <img id="visionImage" class="w-full h-80 object-cover border border-white/10 shadow-2xl transition-transform duration-1000 group-hover:scale-110" src="" alt="Vigneux Vision">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-transparent to-transparent opacity-80"></div>
                <div class="absolute bottom-8 left-10 right-10">
                    <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-2">Projection Architectural</p>
                    <p class="text-sm text-white font-semibold italic">"Modernisation et transition écologique du territoire de Vigneux-sur-Seine."</p>
                </div>
            </div>
        </div>

        <footer class="mt-20 text-center pb-10">
            <p class="text-slate-700 text-[10px] font-black uppercase tracking-[0.5em]">Vision Confidentielle • Simulation Par Hedi Mechichi</p>
        </footer>
    </div>

    <script>
        const apiKey = "";
        const BASE_R = 45.0; 
        const BASE_D = 41.6;
        const STOCK_DETTE = 24.5;

        let metrics = {};

        const ctx = document.getElementById('mainChart').getContext('2d');
        const mainChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['2025', '2026', '2027', '2028', '2029', '2030'],
                datasets: [{
                    data: [3.4, 3.4, 3.4, 3.4, 3.4, 3.4],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.05)',
                    borderWidth: 4,
                    pointRadius: 4,
                    pointBackgroundColor: '#3b82f6',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { display: false, min: 0 },
                    x: { grid: { display: false }, ticks: { color: '#475569', font: { weight: 'bold', size: 10 } } }
                }
            }
        });

        function update() {
            const tax = parseFloat(document.getElementById('taxSlider').value);
            const investTotal = parseFloat(document.getElementById('investSlider').value);
            const subRate = parseFloat(document.getElementById('subSlider').value);

            document.getElementById('taxVal').innerText = (tax >= 0 ? '+' : '') + tax + '%';
            document.getElementById('investVal').innerText = investTotal + " M€";
            document.getElementById('subVal').innerText = subRate + "%";

            const r = BASE_R * (1 + (tax / 100));
            const e = r - BASE_D;
            const subventions = investTotal * (subRate / 100);
            const resteAFinancer = Math.max(0, investTotal - subventions);
            
            const caf = Math.max(0, e - 1.5 - (resteAFinancer * 0.038)); 
            const ratio = e > 0.1 ? ((STOCK_DETTE + resteAFinancer) / e) : 50;

            document.getElementById('metricCAF').innerText = caf.toFixed(2) + " M€";
            document.getElementById('metricDette').innerText = ratio.toFixed(1) + " ans";
            
            const indicator = document.getElementById('statusIndicator');
            if (ratio < 8.5) { 
                indicator.className = "w-4 h-4 rounded-full transition-all status-glow-green bg-emerald-500"; 
            } else if (ratio < 11.5) { 
                indicator.className = "w-4 h-4 rounded-full transition-all status-glow-orange bg-orange-500"; 
            } else { 
                indicator.className = "w-4 h-4 rounded-full transition-all status-glow-red bg-rose-500"; 
            }

            mainChart.data.datasets[0].data = [3.4, e, e*1.02, e*1.04, e*1.06, e*1.08];
            mainChart.update();

            metrics = { r, e, caf, ratio, investTotal, subRate, tax, resteAFinancer };
        }

        ['taxSlider', 'investSlider', 'subSlider'].forEach(id => document.getElementById(id).addEventListener('input', update));

        function generateLocalStrategicNote(m) {
            let note = `<p><strong>Diagnostic de la Direction :</strong> La trajectoire simulée pour un investissement de <strong>${m.investTotal} M€</strong> dégage une épargne brute de <strong>${m.e.toFixed(2)} M€</strong>.</p>`;
            
            if (m.ratio > 12) {
                note += `<p class="verdict-red">⚠️ ANALYSE D'ALERTE : En tant que Directeur Financier, je pose un avis défavorable. Avec un délai de désendettement de <strong>${m.ratio.toFixed(1)} ans</strong>, la ville franchit le seuil de solvabilité critique. L'autofinancement net est saturé.</p>`;
            } else if (m.ratio > 10) {
                note += `<p class="text-orange-400 font-bold">⚠️ VIGILANCE : Le ratio de <strong>${m.ratio.toFixed(1)} ans</strong> nous place dans la zone de surveillance. Il est impératif de sécuriser au moins 60% de subventions pour ce projet.</p>`;
            } else {
                note += `<p class="verdict-green">✅ VALIDATION : Scénario soutenable. Un ratio de <strong>${m.ratio.toFixed(1)} ans</strong> permet de préserver la capacité d'investissement future tout en réalisant le programme de mandat.</p>`;
            }
            return note;
        }

        document.getElementById('wowBtn').addEventListener('click', async () => {
            const section = document.getElementById('aiSection');
            const content = document.getElementById('aiContent');
            const loading = document.getElementById('aiLoading');
            const imgBox = document.getElementById('imageBox');
            const img = document.getElementById('visionImage');
            const container = document.getElementById('aiContainer');

            section.classList.remove('hidden');
            section.scrollIntoView({ behavior: 'smooth' });
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            imgBox.classList.add('hidden');

            const sysPrompt = `Tu es Hedi Mechichi, Directeur des Finances expert de Vigneux-sur-Seine. Rédige une note administrative M57 courte (3 points). Ton verdict doit être : REJETÉ si ratio > 12 ou CAF < 1.0, VALIDÉ si ratio < 9. Ne signe pas à la fin du texte car ton nom est déjà présent dans l'interface.`;
            const userPrompt = `Simulation : Investissement ${metrics.investTotal}M€, Fiscalité ${metrics.tax}%, CAF Nette ${metrics.caf.toFixed(2)}M€, Désendettement ${metrics.ratio.toFixed(1)}ans. Verdict ?`;

            try {
                // Appel Gemini
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: sysPrompt }] } })
                }).then(r => r.json());

                const text = res.candidates[0].content.parts[0].text;
                content.innerHTML = text.split('\n').filter(p => p.trim()).map(p => {
                    let cls = "";
                    if (p.includes("REJETÉ") || p.includes("NON SOUTENABLE")) cls = "verdict-red";
                    if (p.includes("VALIDÉ") || p.includes("SOUTENABLE")) cls = "verdict-green";
                    return `<p class="${cls}">${p.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>`;
                }).join('');

                // Image IA (Fallback nano-banana)
                const imgPrompt = `Cinematic 8k architectural concept of a modern sustainable public building in Vigneux-sur-Seine France, with gardens and solar panels, dusk.`;
                const imgRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instances: { prompt: imgPrompt }, parameters: { sampleCount: 1 } })
                }).then(r => r.json());

                if (imgRes.predictions?.[0]?.bytesBase64Encoded) {
                    img.src = `data:image/png;base64,${imgRes.predictions[0].bytesBase64Encoded}`;
                    imgBox.classList.remove('hidden');
                }
            } catch (e) {
                content.innerHTML = generateLocalStrategicNote(metrics);
            } finally {
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                container.className = metrics.ratio > 12 ? "glass p-10 rounded-[3.5rem] border-2 border-rose-600 shadow-3xl" : "glass p-10 rounded-[3.5rem] border-2 border-blue-500 shadow-3xl";
            }
        });

        window.onload = update;
    </script>
</body>
</html>

